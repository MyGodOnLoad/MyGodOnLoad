<!DOCTYPE html>
<html lang=en>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="一名菜鸟的日记本">
    <meta property="og:type" content="website">
    <meta name="description" content="一名菜鸟的日记本">
    <meta name="keyword"  content="">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        即时通讯 - 神秘的张少爷
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="../../../../../../css/aircloud.css">

    
<link rel="stylesheet" href="../../../../../../css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>

    
  
  



  



  




  
  
  



  

<meta name="generator" content="Hexo 7.2.0"><link rel="alternate" href="atom.xml" title="神秘的张少爷" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Stay Hungry，Stay Foolish </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar radius">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>神秘的张少爷</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="../../../../../../index.html">
                    <i class="iconfont icon-shouye1"></i>
                    <span>HOME</span>
                </a>
            </li>
            <li >
                <a href="../../../../../../tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>TAGS</span>
                </a>
            </li>
            <li >
                <a href="../../../../../../archives">
                    <i class="iconfont icon-guidang2"></i>
                    <span>ARCHIVES</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>COLLECT</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>ABOUT</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>SEARCH</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF"><span class="toc-text">一. 即时通讯</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF%E4%BB%8B%E7%BB%8D"><span class="toc-text">1. 即时通讯介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-websocket%E5%92%8Csocketio"><span class="toc-text">2. websocket和socketio</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%90%AD%E5%BB%BAsocketio%E6%9C%8D%E5%8A%A1%E5%99%A8-%E9%87%8D%E7%82%B9"><span class="toc-text">3. 搭建socketio服务器 (重点)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E4%BA%8B%E4%BB%B6%E5%A4%84%E7%90%86-%E9%87%8D%E7%82%B9"><span class="toc-text">4. 事件处理 (重点)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E9%A1%B9%E7%9B%AE%E5%8A%9F%E8%83%BD-%E8%81%8A%E5%A4%A9"><span class="toc-text">5. 项目功能-聊天</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6-%E9%A1%B9%E7%9B%AE%E5%8A%9F%E8%83%BD-%E6%B6%88%E6%81%AF%E6%8E%A8%E9%80%81-%E9%87%8D%E7%82%B9"><span class="toc-text">6. 项目功能-消息推送 (重点)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#django%E4%B8%AD%E4%BD%BF%E7%94%A8websocket"><span class="toc-text">django中使用websocket</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">search</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Stay Hungry，Stay Foolish </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        即时通讯
    </div>

    <div class="post-meta">
        <span class="attr">Post：<span>2024-05-19 20:45:57</span></span>
        
        <span class="attr">Tags：/
        
        <a class="tag" href="/tags/#即时通讯socket" title="即时通讯socket">即时通讯socket</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">Visit：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h3 id="一-即时通讯"><a href="#一-即时通讯" class="headerlink" title="一. 即时通讯"></a>一. 即时通讯</h3><h4 id="1-即时通讯介绍"><a href="#1-即时通讯介绍" class="headerlink" title="1. 即时通讯介绍"></a>1. 即时通讯介绍</h4><ul>
<li><p>即时通讯是基于<code>TCP长连接</code>, 建立连接之后, 客户端&#x2F;服务器可以无限次随时向对端发送数据, 实现服务器数据发送的即时性</p>
</li>
<li><p>http是短连接, 设计的目的是减少服务器的压力</p>
</li>
<li><p>http伪即时通讯</p>
<ul>
<li>轮训  emmet</li>
<li>长轮训  long pulling</li>
</ul>
</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811084830091.png" alt="image-20190811084830091"></p>
<ul>
<li><p>使用场景</p>
<ul>
<li>聊天功能</li>
<li>在线即时推送   如下单后立即推送给商户</li>
</ul>
</li>
<li><p>实现即时通讯</p>
<ul>
<li><p>自己搭建服务器</p>
<ul>
<li>选择支持的协议  websocket xmpp</li>
<li>使用一些比较成熟的框架  socketio  xmppframework</li>
<li>自己封装socket</li>
</ul>
</li>
<li><p>使用成熟的第三方方案</p>
<ul>
<li>融云 环信</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="2-websocket和socketio"><a href="#2-websocket和socketio" class="headerlink" title="2. websocket和socketio"></a>2. websocket和socketio</h4><ul>
<li>websocket和http都是基于tcp</li>
<li>http建立的是短连接, 而websocket建立的是长连接</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190717151126373.png" alt="image-20190717151126373"></p>
<ul>
<li><p>socket.io是基于websocket协议的一套成熟的解决方案</p>
<ul>
<li>优点<ul>
<li>性能好</li>
<li>支持多平台</li>
</ul>
</li>
<li>缺点<ul>
<li>传输的数据并不完全遵循websocket协议, 这就要求客户端和服务端都必须使用socket.io解决方案</li>
</ul>
</li>
<li>安装 <code>pip install python-socketio</code></li>
</ul>
</li>
</ul>
<h4 id="3-搭建socketio服务器-重点"><a href="#3-搭建socketio服务器-重点" class="headerlink" title="3. 搭建socketio服务器 (重点)"></a>3. 搭建socketio服务器 (重点)</h4><ul>
<li>搭建支持协程的socket服务器</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install python-socketio</span><br><span class="line">pip install eventlet  # eventlet包提供了协程的支持</span><br></pre></td></tr></table></figure>

<ul>
<li>安装chrome插件firecamp  用于测试socketio请求</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811093000913.png" alt="image-20190811093000913"></p>
<h4 id="4-事件处理-重点"><a href="#4-事件处理-重点" class="headerlink" title="4. 事件处理 (重点)"></a>4. 事件处理 (重点)</h4><ul>
<li>事件: 类似于http中的路由</li>
<li>消息: 类似于http中的请求</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811101056944.png" alt="image-20190811101056944"></p>
<h4 id="5-项目功能-聊天"><a href="#5-项目功能-聊天" class="headerlink" title="5. 项目功能-聊天"></a>5. 项目功能-聊天</h4><p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811102506509.png" alt="image-20190811102506509"></p>
<h4 id="6-项目功能-消息推送-重点"><a href="#6-项目功能-消息推送-重点" class="headerlink" title="6. 项目功能-消息推送 (重点)"></a>6. 项目功能-消息推送 (重点)</h4><ul>
<li>RPC和消息队列的对比<ul>
<li>如果需要服务端立即返回结果, 最好使用RPC(效率高, 不需要中转)</li>
<li>如果不需要服务端返回结果, 可以使用消息队列(消费者可以执行异步任务, 减轻同一时间服务器的并发压力)</li>
</ul>
</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811164325759.png" alt="image-20190811164325759"></p>
<ul>
<li>将推送消息放入消息队列中</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190719110510834.png" alt="image-20190719110510834"></p>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190719110552211.png" alt="image-20190719110552211"></p>
<ul>
<li>获取用户身份</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811172316467.png" alt="image-20190811172316467"></p>
<ul>
<li>IM服务器从消息队列中获取数据</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811174353499.png" alt="image-20190811174353499"></p>
<ul>
<li>IM<ul>
<li>当用户连接IM时, 取出user_id, 并进入其user_id对应的房间</li>
<li>从消息队列中取出关注通知</li>
</ul>
</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811174538414.png" alt="image-20190811174538414"></p>
<ul>
<li>web服务器<ul>
<li>将关注通知放入消息队列, 消息发送给作者的user_id对应的房间</li>
</ul>
</li>
</ul>
<p><img src="/2024/05/19/Python/%E8%AF%BE%E7%A8%8B/26_flask%E9%A1%B9%E7%9B%AE9-%E5%8D%B3%E6%97%B6%E9%80%9A%E8%AE%AF/index/image-20190811174717532.png" alt="image-20190811174717532"></p>
<ul>
<li><p>细节</p>
<ul>
<li>测试  web应用必须使用生产模式,否则消息队列管理器会报错</li>
</ul>
</li>
<li><p>RabbitMQ  <code>amqp://guest:guest@192.168.105.128:5672</code></p>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">上线收到通知的逻辑</span><br><span class="line">1. 用户一旦连接IM, </span><br><span class="line"><span class="meta prompt_">1&gt; </span><span class="language-bash">需要让user_id和sid建立关系</span></span><br><span class="line"><span class="meta prompt_">2&gt; </span><span class="language-bash">一旦离线就删除关系</span>  </span><br><span class="line"><span class="meta prompt_">3&gt; </span><span class="language-bash">关系可以存在redis中</span></span><br><span class="line"></span><br><span class="line">2.web应用</span><br><span class="line"><span class="meta prompt_">1&gt; </span><span class="language-bash">从redis中取user_id对应的sid</span></span><br><span class="line"><span class="meta prompt_">2&gt; </span><span class="language-bash">如果能取出, 说明在线, 直接往消息队列中添加消息</span></span><br><span class="line"><span class="meta prompt_">3&gt; </span><span class="language-bash">如果不能取出, 说明离线, 将消息保存到redis中</span> </span><br><span class="line"></span><br><span class="line">3. im应用</span><br><span class="line"><span class="meta prompt_">1&gt; </span><span class="language-bash">一旦建立连接, 先从redis中查询是否有消息被保存</span></span><br><span class="line"><span class="meta prompt_">2&gt; </span><span class="language-bash">如果有,取出并发给客户端, 取出后从redis中删除数据</span></span><br><span class="line"><span class="meta prompt_">3&gt; </span><span class="language-bash">同时还需要从消息队列中实时取出消息数据</span></span><br></pre></td></tr></table></figure>


<h4 id="django中使用websocket"><a href="#django中使用websocket" class="headerlink" title="django中使用websocket"></a>django中使用websocket</h4><ul>
<li><strong>dwebsocket</strong><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip <span class="keyword">install</span> dwebsocket</span><br></pre></td></tr></table></figure></li>
</ul>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_39726347/article/details/88045752">https://blog.csdn.net/weixin_39726347/article/details/88045752</a></p>
<ul>
<li>使用方法1:</li>
</ul>
<p>只需views.py文件中,将对应的视图函数添加装饰器</p>
<ul>
<li>accept_websocket-—可以接受websocket请求和普通http请求</li>
<li>require_websocket—-只接受websocket请求,拒绝普通http请求</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dwebsocket.decorators <span class="keyword">import</span> accept_websocket,require_websocket</span><br><span class="line"><span class="meta">@accept_websocket</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_websocket</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.is_websocket():</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>) <span class="comment">## 向前端发送时间</span></span><br><span class="line">            dit = &#123;</span><br><span class="line">                <span class="string">&#x27;time&#x27;</span>:time.strftime(<span class="string">&#x27;%Y.%m.%d %H:%M:%S&#x27;</span>,time.localtime(time.time()))</span><br><span class="line">            &#125;</span><br><span class="line">            request.websocket.send(json.dumps(dit))</span><br></pre></td></tr></table></figure>


<p>使用方法2: </p>
<ul>
<li><em>使用中间件</em></li>
</ul>
<p>步骤:</p>
<ol>
<li>settings.py文件中,添加如下信息</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dwebsocket</span><br><span class="line"></span><br><span class="line"><span class="comment"># 为所有的URL提供websocket，如果只是单独的视图需要可以不选</span></span><br><span class="line"></span><br><span class="line">MIDDLEWARE_CLASSES=[<span class="string">&#x27;dwebsocket.middleware.WebSocketMiddleware&#x27;</span>]</span><br><span class="line"></span><br><span class="line">WEBSOCKET_ACCEPT_ALL=<span class="literal">True</span>  <span class="comment"># 可以允许每一个单独的视图实用websockets</span></span><br></pre></td></tr></table></figure>

<p>官方说明:做了如上配置,仍然会拒绝普通视图的websockets。所以必须在视图上设置’ accept_websocket ’ ‘属性来允许websockets,所以继续做如下配置。</p>
<ol start="2">
<li>views.py文件中,相关视图添加装饰器</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> dwebsocket.decorators <span class="keyword">import</span> accept_websocket,require_websocket</span><br><span class="line"></span><br><span class="line"><span class="meta">@accept_websocket</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test_websocket</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.is_websocket():</span><br><span class="line">        <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">            time.sleep(<span class="number">1</span>) <span class="comment">## 向前端发送时间</span></span><br><span class="line">            dit = &#123;</span><br><span class="line">                <span class="string">&#x27;time&#x27;</span>:time.strftime(<span class="string">&#x27;%Y.%m.%d %H:%M:%S&#x27;</span>,time.localtime(time.time()))</span><br><span class="line">            &#125;</span><br><span class="line">            request.websocket.send(json.dumps(dit))</span><br></pre></td></tr></table></figure>

<p>看起来跟方法一没什么区别,还多了一步settings配置,但是区别在哪呢???<br>官方是这么说的:These attributes are always available if you use the middleware<br>翻译过来就是,如果使用中间件,有以下这下方法可用:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">request.is_websocket()  <span class="comment">#websocket请求返回True,普通请求返回False</span></span><br><span class="line">request.websocket  <span class="comment"># websocket建立连接后,request将有websocket提供的相关api属性,如果没有建立连接则是None</span></span><br><span class="line">WebSocket.wait()  <span class="comment"># 阻塞接收消息</span></span><br><span class="line">WebSocket.read()  <span class="comment"># 非阻塞接收消息</span></span><br><span class="line">WebSocket.count_messages()  <span class="comment">#返回队列中的消息数量</span></span><br><span class="line">WebSocket.has_messages()  <span class="comment"># 有消息返回True,反之False</span></span><br><span class="line">WebSocket.send(message)  <span class="comment"># 发送消息</span></span><br><span class="line">WebSocket.__iter__()  <span class="comment"># 当迭代器使用</span></span><br></pre></td></tr></table></figure>

<p>官方连接 <a target="_blank" rel="noopener" href="https://pypi.org/project/dwebsocket/0.4.2/">https://pypi.org/project/dwebsocket/0.4.2/</a></p>
<p><strong>前端测试文件</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">&quot;WebSocketTest()&quot;</span>&gt;</span>test<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">function</span> <span class="title function_">WebSocketTest</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="title function_">alert</span>(<span class="number">1</span>)</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">if</span> (<span class="string">&quot;WebSocket&quot;</span> <span class="keyword">in</span> <span class="variable language_">window</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;您的浏览器支持 WebSocket!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 打开一个 web socket</span></span></span><br><span class="line"><span class="language-javascript">            ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://192.168.1.51:8002/wx_app/alert_info/?room_id=0122011657&quot;</span>); </span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            ws.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// Web Socket 已连接上，使用 send() 方法发送数据</span></span></span><br><span class="line"><span class="language-javascript">                ws.<span class="title function_">send</span>(<span class="string">&quot;发送数据&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;数据发送中...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            ws.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> received_msg = evt.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;数据已接收...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;数据:&quot;</span> + received_msg)</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">            ws.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="comment">// 关闭 websocket</span></span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">alert</span>(<span class="string">&quot;连接已关闭...&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">// 浏览器不支持 WebSocket</span></span></span><br><span class="line"><span class="language-javascript">            <span class="title function_">alert</span>(<span class="string">&quot;您的浏览器不支持 WebSocket!&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>


<ul>
<li><strong>channel</strong></li>
</ul>

        
            <div class="donate-container">
    <div class="donate-button">
        <button id="donate-button">donate</button>
    </div>
    <div class="donate-img-container hide" id="donate-img-container">
        <img id="donate-img" src="" data-src="/img/donate.jpg">
        <p> 感谢您给予的支持 </p>
    </div>
</div>
        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        
        <li>
            <a target="_blank" href="https://www.zhihu.com/people/忘機">
                            <span class="fa-stack fa-lg">
                                 <i class="iconfont icon-zhihu"></i>
                            </span>
            </a>
        </li>
        

        
        <li>
            <a target="_blank" href="http://weibo.com/3919408003">
                            <span class="fa-stack fa-lg">
                                  <i class="iconfont icon-weibo"></i>
                            </span>
            </a>
        </li>
        

        

        
        <li>
            <a target="_blank"  href="https://github.com/MyGodOnLoad">
                            <span class="fa-stack fa-lg">
                                <i class="iconfont icon-github"></i>
                            </span>
            </a>
        </li>
        

        

    </ul>
    
    <p>
        <span id="busuanzi_container_site_pv">
            <span id="busuanzi_value_site_pv"></span>PV
        </span>
        <span id="busuanzi_container_site_uv">
            <span id="busuanzi_value_site_uv"></span>UV
        </span>
        Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>  Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p>
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="../../../../../../js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
